name: åŒæ­¥Forkä¸ä¸Šæ¸¸ä»“åº“

on:
  schedule:
    - cron: "0 2 * * 2"   # æ¯å‘¨äºŒå‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆé¿å¼€å‘¨æœ«é«˜å³°ï¼‰
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆå¿½ç•¥åˆ é™¤ä¿æŠ¤ï¼‰'
        required: false
        default: 'false'
        type: boolean
      delete_files_threshold:
        description: 'åˆ é™¤æ–‡ä»¶æ•°é‡é˜ˆå€¼ (%)'
        required: false
        default: '40'
      readme_diff_threshold:
        description: 'README.md å·®å¼‚æ¯”ä¾‹é˜ˆå€¼ (%)'
        required: false
        default: '50'
      critical_files_threshold:
        description: 'å…³é”®æ„å»ºæ–‡ä»¶åˆ é™¤æ•°é‡é˜ˆå€¼'
        required: false
        default: '5'
      total_change_threshold:
        description: 'æ€»å˜åŒ–ç‡é˜ˆå€¼ (%)'
        required: false
        default: '60'
      code_lines_threshold:
        description: 'ä»£ç æ€»å˜åŒ–è¡Œæ•°é˜ˆå€¼'
        required: false
        default: '2000'
      total_weight:
        description: 'å¸¸è§„æ¨¡å¼-æ€»å˜åŒ–æƒé‡ (%)'
        required: false
        default: '70'
      net_weight:
        description: 'å¸¸è§„æ¨¡å¼-å‡€å˜åŒ–æƒé‡ (%)'
        required: false
        default: '30'
      overlap_threshold_high:
        description: 'é‡æ„æ¨¡å¼è§¦å‘é˜ˆå€¼ (%)'
        required: false
        default: '80'
      overlap_threshold_mid:
        description: 'å¤§è§„æ¨¡æ›´æ–°è§¦å‘é˜ˆå€¼ (%)'
        required: false
        default: '60'

env:
  DELETE_FILES_THRESHOLD: ${{ github.event.inputs.delete_files_threshold || '40' }}
  README_DIFF_THRESHOLD: ${{ github.event.inputs.readme_diff_threshold || '50' }}
  CRITICAL_FILES_THRESHOLD: ${{ github.event.inputs.critical_files_threshold || '5' }}
  TOTAL_CHANGE_THRESHOLD: ${{ github.event.inputs.total_change_threshold || '60' }}
  CODE_LINES_THRESHOLD: ${{ github.event.inputs.code_lines_threshold || '2000' }}
  TOTAL_WEIGHT: ${{ github.event.inputs.total_weight || '70' }}
  NET_WEIGHT: ${{ github.event.inputs.net_weight || '30' }}
  OVERLAP_THRESHOLD_HIGH: ${{ github.event.inputs.overlap_threshold_high || '80' }}
  OVERLAP_THRESHOLD_MID: ${{ github.event.inputs.overlap_threshold_mid || '60' }}
  UPSTREAM_REPO: "xiaoyaocz/dart_simple_live"  # ä¿®æ”¹ä¸ºä½ çš„ä¸Šæ¸¸ä»“åº“

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºForkä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: éªŒè¯ä¸Šæ¸¸ä»“åº“é…ç½®
        id: validate_repos
        run: |
          echo "===== ğŸ” éªŒè¯ä»“åº“å…³ç³» ====="
          
          UPSTREAM_REPO="${{ env.UPSTREAM_REPO }}"
          
          # æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦é…ç½®
          if [[ -z "$UPSTREAM_REPO" ]]; then
            echo "::error::âŒ æœªé…ç½®ä¸Šæ¸¸ä»“åº“ï¼"
            echo "è¯·åœ¨ workflow æ–‡ä»¶çš„ env éƒ¨åˆ†è®¾ç½®ï¼š"
            echo '  UPSTREAM_REPO: "owner/repo"'
            exit 1
          fi
          
          echo "ğŸ“Œ å½“å‰ä»“åº“: ${{ github.repository }}"
          echo "ğŸ“ é…ç½®çš„ä¸Šæ¸¸: $UPSTREAM_REPO"
          echo ""
          
          # éªŒè¯ä¸Šæ¸¸ä»“åº“æ˜¯å¦å­˜åœ¨ä¸”å¯è®¿é—®
          echo "ğŸŒ éªŒè¯ä¸Šæ¸¸ä»“åº“å¯è®¿é—®æ€§..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                        "https://api.github.com/repos/$UPSTREAM_REPO")
          
          if [[ "$HTTP_STATUS" == "200" ]]; then
            echo "âœ… ä¸Šæ¸¸ä»“åº“å­˜åœ¨ä¸”å¯è®¿é—®"
          elif [[ "$HTTP_STATUS" == "404" ]]; then
            echo "::error::âŒ ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨: $UPSTREAM_REPO"
            echo "è¯·æ£€æŸ¥ä»“åº“åç§°æ˜¯å¦æ­£ç¡®"
            exit 1
          elif [[ "$HTTP_STATUS" == "403" ]]; then
            # APIé™åˆ¶æ—¶å°è¯•ç›´æ¥gitè®¿é—®
            echo "âš ï¸ APIè®¿é—®å—é™ï¼Œå°è¯•ç›´æ¥Gitè®¿é—®..."
            if git ls-remote "https://github.com/${UPSTREAM_REPO}.git" HEAD &>/dev/null; then
              echo "âœ… ä¸Šæ¸¸ä»“åº“å¯é€šè¿‡Gitè®¿é—®"
            else
              echo "::error::âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“ï¼ˆå¯èƒ½æ˜¯ç§æœ‰ä»“åº“ï¼‰"
              exit 1
            fi
          else
            echo "::error::âŒ æ— æ³•è®¿é—®ä¸Šæ¸¸ä»“åº“ (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: æ·»åŠ ä¸Šæ¸¸ä»“åº“
        if: steps.validate_repos.outputs.validation_passed == 'true'
        run: |
          # æ·»åŠ æˆ–æ›´æ–°ä¸Šæ¸¸ä»“åº“
          if git remote get-url upstream >/dev/null 2>&1; then
            git remote set-url upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          else
            git remote add upstream https://github.com/${{ env.UPSTREAM_REPO }}.git
          fi
          
          # è·å–æ‰€æœ‰æ›´æ–°
          echo "ğŸ“¥ è·å–ä¸Šæ¸¸å’Œoriginçš„æœ€æ–°ä»£ç ..."
          git fetch upstream
          git fetch origin

      - name: æ£€æµ‹åˆ†æ”¯ä¿¡æ¯
        id: detect_branches
        if: steps.validate_repos.outputs.validation_passed == 'true'
        run: |
          # è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸çš„é»˜è®¤åˆ†æ”¯
          UPSTREAM_BRANCH=$(git remote show upstream | grep "HEAD branch" | sed 's/.*: //' | tr -d '[:space:]')
          
          # å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œå°è¯•å¸¸è§åˆ†æ”¯å
          if [[ -z "$UPSTREAM_BRANCH" ]]; then
            echo "âš ï¸ æ— æ³•è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯ï¼Œå°è¯•å¸¸è§åˆ†æ”¯å..."
            for branch in main master; do
              if git show-ref --verify --quiet "refs/remotes/upstream/$branch"; then
                UPSTREAM_BRANCH=$branch
                echo "æ‰¾åˆ°ä¸Šæ¸¸åˆ†æ”¯: $branch"
                break
              fi
            done
          fi
          
          # è·å–æœ¬åœ°å½“å‰åˆ†æ”¯
          LOCAL_BRANCH=$(git branch --show-current | tr -d '[:space:]')
          
          if [[ -z "$UPSTREAM_BRANCH" || -z "$LOCAL_BRANCH" ]]; then
            echo "âŒ æ— æ³•æ£€æµ‹åˆ†æ”¯"
            echo "  ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯: ${UPSTREAM_BRANCH:-æœªæ£€æµ‹åˆ°}"
            echo "  æœ¬åœ°å½“å‰åˆ†æ”¯: ${LOCAL_BRANCH:-æœªæ£€æµ‹åˆ°}"
            exit 1
          fi
          
          echo "ğŸ“Œ æ£€æµ‹åˆ°çš„åˆ†æ”¯ï¼š"
          echo "  ä¸Šæ¸¸é»˜è®¤åˆ†æ”¯: $UPSTREAM_BRANCH"
          echo "  æœ¬åœ°å½“å‰åˆ†æ”¯: $LOCAL_BRANCH"
          
          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          echo "local_branch=$LOCAL_BRANCH" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥
        id: check_sync_needed
        if: steps.detect_branches.outputs.upstream_branch != ''
        run: |
          UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          
          # æ¯”è¾ƒæœ¬åœ°å’Œä¸Šæ¸¸æ˜¯å¦æœ‰å·®å¼‚
          if git diff --quiet "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH"; then
            echo "âœ… Fork å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€åŒæ­¥"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "ğŸ”„ æ£€æµ‹åˆ°ä¸Šæ¸¸æœ‰æ›´æ–°ï¼Œéœ€è¦åŒæ­¥"
            
            # æ˜¾ç¤ºè½åçš„æäº¤æ•°
            COMMITS_BEHIND=$(git rev-list --count "origin/$LOCAL_BRANCH..upstream/$UPSTREAM_BRANCH" 2>/dev/null || echo "unknown")
            echo "  è½åä¸Šæ¸¸ $COMMITS_BEHIND ä¸ªæäº¤"
            
            echo "needs_sync=true" >> $GITHUB_OUTPUT
          fi

      - name: åˆå§‹åŒ–ä¿æŠ¤æ—¥å¿—
        id: init_protection_log
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          mkdir -p /tmp/sync_logs
          LOG_FILE="/tmp/sync_logs/protection.log"
          
          echo "===== ğŸ›¡ï¸ åŒæ­¥ä¿æŠ¤æ—¥å¿— =====" > "$LOG_FILE"
          echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> "$LOG_FILE"
          echo "å½“å‰ä»“åº“: ${{ github.repository }}" >> "$LOG_FILE"
          echo "ä¸Šæ¸¸ä»“åº“: ${{ env.UPSTREAM_REPO }}" >> "$LOG_FILE"
          echo "================================" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"
          
          echo "log_file=$LOG_FILE" >> $GITHUB_OUTPUT

      - name: å¤‡ä»½ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ
        id: backup_workflows
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          BACKUP_DIR="/tmp/my_workflows_backup"
          mkdir -p "$BACKUP_DIR"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          echo "ğŸ“¦ å¼€å§‹å¤‡ä»½ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ..." | tee -a "$LOG_FILE"
          BACKUP_COUNT=0
          
          # åªå¤‡ä»½ my-*.yml æ–‡ä»¶
          if [[ -d ".github/workflows" ]]; then
            for FILE in .github/workflows/my-*.yml .github/workflows/my-*.yaml; do
              if [[ -f "$FILE" ]]; then
                FILENAME=$(basename "$FILE")
                cp -p "$FILE" "$BACKUP_DIR/$FILENAME"
                BACKUP_COUNT=$((BACKUP_COUNT + 1))
                echo "  å¤‡ä»½: $FILENAME" | tee -a "$LOG_FILE"
              fi
            done
          fi
          
          if [[ $BACKUP_COUNT -gt 0 ]]; then
            echo "ğŸ“¦ å·²å¤‡ä»½ $BACKUP_COUNT ä¸ªç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ" | tee -a "$LOG_FILE"
          else
            echo "â„¹ï¸ æ²¡æœ‰å‘ç°ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ (my-*.yml)" | tee -a "$LOG_FILE"
          fi
          
          echo "backup_count=$BACKUP_COUNT" >> $GITHUB_OUTPUT
          echo "backup_dir=$BACKUP_DIR" >> $GITHUB_OUTPUT

      - name: æ™ºèƒ½åˆ†æä¸Šæ¸¸å˜æ›´
        id: analyze_changes
        if: steps.check_sync_needed.outputs.needs_sync == 'true'
        run: |
          UPSTREAM_BRANCH="${{ steps.detect_branches.outputs.upstream_branch }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          # å…³é”®æ„å»ºæ–‡ä»¶çš„æ­£åˆ™è¡¨è¾¾å¼
          CRITICAL_PATTERNS_REGEX="(Dockerfile|docker-compose.*\.(yml|yaml)|Makefile|CMakeLists\.txt|.*\.gradle(\.kts)?|pom\.xml|package(-lock)?\.json|yarn\.lock|go\.(mod|sum)|requirements\.txt|Pipfile(\.lock)?|pyproject\.toml|setup\.(py|cfg)|\.github/workflows/.*\.(yml|yaml))"
          
          echo "===== ğŸ“Š å¼€å§‹åˆ†æå˜æ›´ =====" | tee -a "$LOG_FILE"
          
          # è·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…é‡å¤è®¡ç®—ï¼‰
          LOCAL_FILES_TMP=$(mktemp)
          UPSTREAM_FILES_TMP=$(mktemp)
          git ls-tree -r --name-only "origin/$LOCAL_BRANCH" | sort > "$LOCAL_FILES_TMP"
          git ls-tree -r --name-only "upstream/$UPSTREAM_BRANCH" | sort > "$UPSTREAM_FILES_TMP"
          
          # è®¡ç®—æ–‡ä»¶æ€»æ•°
          TOTAL_LOCAL_FILES=$(wc -l < "$LOCAL_FILES_TMP")
          TOTAL_UPSTREAM_FILES=$(wc -l < "$UPSTREAM_FILES_TMP")
          
          # è®¡ç®—æ–‡ä»¶å˜åŒ–
          DELETED_COUNT=$(comm -23 "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" | wc -l)
          ADDED_COUNT=$(comm -13 "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" | wc -l)
          MODIFIED_COUNT=$(git diff --diff-filter=MR --name-only "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | wc -l)
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶åˆ é™¤
          CRITICAL_DELETED=$(comm -23 "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP" | grep -cE "$CRITICAL_PATTERNS_REGEX" || echo 0)
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$LOCAL_FILES_TMP" "$UPSTREAM_FILES_TMP"
          
          # è·å–ä»£ç è¡Œæ•°å˜åŒ–
          echo "æ­£åœ¨è®¡ç®—ä»£ç å˜åŒ–è¡Œæ•°..." | tee -a "$LOG_FILE"
          LINES_ADDED=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{sum+=$1} END {print sum+0}')
          LINES_DELETED=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" | \
            awk '{sum+=$2} END {print sum+0}')
          
          # ===== æ™ºèƒ½ä»£ç å˜åŒ–åˆ†æ =====
          TOTAL_LINES_CHANGED=$((LINES_ADDED + LINES_DELETED))
          NET_LINES_CHANGED=$((LINES_ADDED - LINES_DELETED))
          ABS_NET_CHANGE=${NET_LINES_CHANGED#-}
          
          # æ™ºèƒ½åˆ¤æ–­å˜é‡åˆå§‹åŒ–
          SMART_LINES_CHANGED=$TOTAL_LINES_CHANGED
          CHANGE_PATTERN="æœªçŸ¥æ¨¡å¼"
          RISK_LEVEL="MEDIUM"
          THRESHOLD_MULTIPLIER="1.0"
          
          # æ™ºèƒ½æ¨¡å¼è¯†åˆ«
          if [[ $LINES_ADDED -gt 0 || $LINES_DELETED -gt 0 ]]; then
            # è®¡ç®—é‡å ç‡
            LARGER_VALUE=$((LINES_ADDED > LINES_DELETED ? LINES_ADDED : LINES_DELETED))
            SMALLER_VALUE=$((LINES_ADDED < LINES_DELETED ? LINES_ADDED : LINES_DELETED))
            
            if [[ $LARGER_VALUE -gt 0 ]]; then
              OVERLAP_RATIO=$((SMALLER_VALUE * 100 / LARGER_VALUE))
            else
              OVERLAP_RATIO=0
            fi
            
            echo "" | tee -a "$LOG_FILE"
            echo "ğŸ§  æ™ºèƒ½ä»£ç å˜åŒ–åˆ†æ:" | tee -a "$LOG_FILE"
            echo "  â€¢ æ–°å¢è¡Œæ•°: +$LINES_ADDED" | tee -a "$LOG_FILE"
            echo "  â€¢ åˆ é™¤è¡Œæ•°: -$LINES_DELETED" | tee -a "$LOG_FILE"
            echo "  â€¢ æ€»å˜åŒ–é‡: $TOTAL_LINES_CHANGED" | tee -a "$LOG_FILE"
            echo "  â€¢ å‡€å˜åŒ–é‡: $NET_LINES_CHANGED" | tee -a "$LOG_FILE"
            echo "  â€¢ é‡å ç‡: ${OVERLAP_RATIO}%" | tee -a "$LOG_FILE"
            
            # æ¨¡å¼è¯†åˆ«å’Œåº¦é‡é€‰æ‹©
            if [[ $OVERLAP_RATIO -gt ${{ env.OVERLAP_THRESHOLD_HIGH }} ]]; then
              CHANGE_PATTERN="ä»£ç é‡æ„"
              SMART_LINES_CHANGED=$TOTAL_LINES_CHANGED
              RISK_LEVEL="HIGH"
              THRESHOLD_MULTIPLIER="0.8"
              echo "  ğŸ”„ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨æ€»å˜åŒ–é‡)" | tee -a "$LOG_FILE"
              
            elif [[ $LINES_ADDED -gt $((LINES_DELETED * 3)) ]]; then
              CHANGE_PATTERN="æ–°åŠŸèƒ½æ·»åŠ "
              SMART_LINES_CHANGED=$NET_LINES_CHANGED
              RISK_LEVEL="MEDIUM"
              THRESHOLD_MULTIPLIER="1.0"
              echo "  âœ¨ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨å‡€å˜åŒ–é‡)" | tee -a "$LOG_FILE"
              
            elif [[ $LINES_DELETED -gt $((LINES_ADDED * 3)) ]]; then
              CHANGE_PATTERN="ä»£ç æ¸…ç†"
              SMART_LINES_CHANGED=$LINES_DELETED
              RISK_LEVEL="MEDIUM"
              THRESHOLD_MULTIPLIER="1.2"
              echo "  ğŸ§¹ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨åˆ é™¤é‡)" | tee -a "$LOG_FILE"
              
            elif [[ $TOTAL_LINES_CHANGED -lt 100 ]]; then
              CHANGE_PATTERN="å°å¹…ä¿®æ”¹"
              SMART_LINES_CHANGED=$TOTAL_LINES_CHANGED
              RISK_LEVEL="LOW"
              THRESHOLD_MULTIPLIER="2.0"
              echo "  ğŸ”§ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨æ€»å˜åŒ–é‡)" | tee -a "$LOG_FILE"
              
            elif [[ $OVERLAP_RATIO -gt ${{ env.OVERLAP_THRESHOLD_MID }} && $TOTAL_LINES_CHANGED -gt 1000 ]]; then
              CHANGE_PATTERN="å¤§è§„æ¨¡æ›´æ–°"
              SMART_LINES_CHANGED=$TOTAL_LINES_CHANGED
              RISK_LEVEL="CRITICAL"
              THRESHOLD_MULTIPLIER="0.5"
              echo "  ğŸš¨ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨æ€»å˜åŒ–é‡)" | tee -a "$LOG_FILE"
              
            else
              CHANGE_PATTERN="å¸¸è§„æ›´æ–°"
              TOTAL_WEIGHT_VAL=${{ env.TOTAL_WEIGHT }}
              NET_WEIGHT_VAL=${{ env.NET_WEIGHT }}
              SMART_LINES_CHANGED=$((TOTAL_LINES_CHANGED * TOTAL_WEIGHT_VAL / 100 + ABS_NET_CHANGE * NET_WEIGHT_VAL / 100))
              RISK_LEVEL="MEDIUM"
              THRESHOLD_MULTIPLIER="1.0"
              echo "  ğŸ“ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN (é‡‡ç”¨åŠ æƒå€¼: ${TOTAL_WEIGHT_VAL}%æ€»+${NET_WEIGHT_VAL}%å‡€)" | tee -a "$LOG_FILE"
            fi
            
            # ç‰¹æ®Šæƒ…å†µæ£€æµ‹
            if [[ $LINES_ADDED -gt 5000 && $LINES_DELETED -lt 100 ]]; then
              echo "  âš ï¸ è­¦å‘Š: æ£€æµ‹åˆ°å¤§é‡ä»£ç æ³¨å…¥ï¼Œéœ€è¦äººå·¥å®¡æ ¸ï¼" | tee -a "$LOG_FILE"
              RISK_LEVEL="CRITICAL"
              THRESHOLD_MULTIPLIER="0.3"
            fi
            
            echo "  ğŸ“Š æ™ºèƒ½å†³ç­–:" | tee -a "$LOG_FILE"
            echo "    â€¢ é‡‡ç”¨å€¼: $SMART_LINES_CHANGED è¡Œ" | tee -a "$LOG_FILE"
            echo "    â€¢ é£é™©ç­‰çº§: $RISK_LEVEL" | tee -a "$LOG_FILE"
            echo "    â€¢ é˜ˆå€¼ç³»æ•°: $THRESHOLD_MULTIPLIER" | tee -a "$LOG_FILE"
          fi
          
          # è®¡ç®—å„ç§æ¯”ç‡
          DELETE_RATIO=0
          CHANGE_RATIO=0
          if [[ $TOTAL_LOCAL_FILES -gt 0 ]]; then
            DELETE_RATIO=$((DELETED_COUNT * 100 / TOTAL_LOCAL_FILES))
            CHANGE_RATIO=$(((DELETED_COUNT + MODIFIED_COUNT) * 100 / TOTAL_LOCAL_FILES))
          fi
          
          # æ£€æŸ¥ README å·®å¼‚
          README_CHANGE_PERCENT=0
          if [[ -f "README.md" ]]; then
            echo "æ­£åœ¨æ£€æŸ¥ README.md å·®å¼‚..." | tee -a "$LOG_FILE"
            if git show "upstream/$UPSTREAM_BRANCH:README.md" &>/dev/null; then
              README_STATS=$(git diff --numstat "origin/$LOCAL_BRANCH" "upstream/$UPSTREAM_BRANCH" -- README.md 2>/dev/null || echo "0 0")
              README_ADDED=$(echo "$README_STATS" | awk '{print $1}')
              README_DELETED=$(echo "$README_STATS" | awk '{print $2}')
              README_TOTAL_CHANGES=$((README_ADDED + README_DELETED))
              ORIGINAL_LINES=$(wc -l < "README.md")
              
              if [[ $ORIGINAL_LINES -gt 0 ]]; then
                README_CHANGE_PERCENT=$((README_TOTAL_CHANGES * 100 / ORIGINAL_LINES))
              fi
              echo "  README.md å˜åŒ–: ${README_CHANGE_PERCENT}%" | tee -a "$LOG_FILE"
            fi
          fi
          
          # è¾“å‡ºå˜æ›´åˆ†ææŠ¥å‘Š
          echo "" | tee -a "$LOG_FILE"
          echo "===== ğŸ“Š å˜æ›´åˆ†ææŠ¥å‘Š =====" | tee -a "$LOG_FILE"
          echo "ğŸ“ æ–‡ä»¶ç»Ÿè®¡:" | tee -a "$LOG_FILE"
          echo "  åˆ é™¤æ–‡ä»¶æ•°: $DELETED_COUNT (${DELETE_RATIO}%)" | tee -a "$LOG_FILE"
          echo "  æ–°å¢æ–‡ä»¶æ•°: $ADDED_COUNT" | tee -a "$LOG_FILE"
          echo "  ä¿®æ”¹æ–‡ä»¶æ•°: $MODIFIED_COUNT" | tee -a "$LOG_FILE"
          echo "  å…³é”®æ–‡ä»¶åˆ é™¤: $CRITICAL_DELETED" | tee -a "$LOG_FILE"
          echo "" | tee -a "$LOG_FILE"
          echo "ğŸ“ ä»£ç è¡Œæ•°å˜åŒ–:" | tee -a "$LOG_FILE"
          echo "  æ™ºèƒ½é‡‡ç”¨å€¼: $SMART_LINES_CHANGED è¡Œ" | tee -a "$LOG_FILE"
          echo "  å˜æ›´æ¨¡å¼: $CHANGE_PATTERN" | tee -a "$LOG_FILE"
          echo "  é£é™©ç­‰çº§: $RISK_LEVEL" | tee -a "$LOG_FILE"
          
          # è¾“å‡ºåˆ° GitHub Actions
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "modified_count=$MODIFIED_COUNT" >> $GITHUB_OUTPUT
          echo "delete_ratio=$DELETE_RATIO" >> $GITHUB_OUTPUT
          echo "change_ratio=$CHANGE_RATIO" >> $GITHUB_OUTPUT
          echo "critical_deleted=$CRITICAL_DELETED" >> $GITHUB_OUTPUT
          echo "lines_changed=$SMART_LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "lines_deleted=$LINES_DELETED" >> $GITHUB_OUTPUT
          echo "readme_change_percent=$README_CHANGE_PERCENT" >> $GITHUB_OUTPUT
          echo "change_pattern=$CHANGE_PATTERN" >> $GITHUB_OUTPUT
          echo "risk_level=$RISK_LEVEL" >> $GITHUB_OUTPUT
          
          # å†³ç­–é€»è¾‘
          SAFE_TO_SYNC=true
          BLOCK_REASONS=""
          
          if [[ "${{ github.event.inputs.force_sync }}" != "true" ]]; then
            # åŠ¨æ€è°ƒæ•´é˜ˆå€¼
            ORIGINAL_THRESHOLD=${{ env.CODE_LINES_THRESHOLD }}
            ADJUSTED_THRESHOLD=$(echo "$ORIGINAL_THRESHOLD * $THRESHOLD_MULTIPLIER" | bc | cut -d. -f1)
            
            echo "" | tee -a "$LOG_FILE"
            echo "ğŸ¯ æ™ºèƒ½é˜ˆå€¼è°ƒæ•´:" | tee -a "$LOG_FILE"
            echo "  â€¢ åŸå§‹é˜ˆå€¼: $ORIGINAL_THRESHOLD è¡Œ" | tee -a "$LOG_FILE"
            echo "  â€¢ è°ƒæ•´åé˜ˆå€¼: $ADJUSTED_THRESHOLD è¡Œ" | tee -a "$LOG_FILE"
            
            # 5ä¸ªé˜ˆå€¼æ£€æŸ¥
            if [[ $CRITICAL_DELETED -gt ${{ env.CRITICAL_FILES_THRESHOLD }} ]]; then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - åˆ é™¤äº† $CRITICAL_DELETED ä¸ªå…³é”®æ„å»ºæ–‡ä»¶ï¼ˆé˜ˆå€¼: ${{ env.CRITICAL_FILES_THRESHOLD }}ï¼‰"
            fi
            
            if [[ $DELETE_RATIO -gt ${{ env.DELETE_FILES_THRESHOLD }} ]]; then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - åˆ é™¤æ–‡ä»¶æ¯”ä¾‹è¿‡é«˜: ${DELETE_RATIO}%ï¼ˆé˜ˆå€¼: ${{ env.DELETE_FILES_THRESHOLD }}%ï¼‰"
            fi
            
            if [[ $CHANGE_RATIO -gt ${{ env.TOTAL_CHANGE_THRESHOLD }} ]]; then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - é¡¹ç›®å˜åŒ–è¿‡å¤§: ${CHANGE_RATIO}%ï¼ˆé˜ˆå€¼: ${{ env.TOTAL_CHANGE_THRESHOLD }}%ï¼‰"
            fi
            
            if [[ $README_CHANGE_PERCENT -gt ${{ env.README_DIFF_THRESHOLD }} ]]; then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - README.md å·®å¼‚è¿‡å¤§: ${README_CHANGE_PERCENT}%ï¼ˆé˜ˆå€¼: ${{ env.README_DIFF_THRESHOLD }}%ï¼‰"
            fi
            
            if [[ $SMART_LINES_CHANGED -gt $ADJUSTED_THRESHOLD ]]; then
              SAFE_TO_SYNC=false
              BLOCK_REASONS="${BLOCK_REASONS}\n  - ä»£ç å˜åŒ–è¿‡å¤§: $SMART_LINES_CHANGED è¡Œï¼ˆæ™ºèƒ½é˜ˆå€¼: $ADJUSTED_THRESHOLD è¡Œï¼‰"
              BLOCK_REASONS="${BLOCK_REASONS}\n    â€¢ æ£€æµ‹æ¨¡å¼: $CHANGE_PATTERN"
              BLOCK_REASONS="${BLOCK_REASONS}\n    â€¢ é£é™©ç­‰çº§: $RISK_LEVEL"
            fi
          else
            echo "âš ï¸ å¼ºåˆ¶åŒæ­¥æ¨¡å¼å·²å¯ç”¨ï¼Œè·³è¿‡æ‰€æœ‰å®‰å…¨æ£€æŸ¥" | tee -a "$LOG_FILE"
          fi
          
          # è¾“å‡ºå†³ç­–ç»“æœ
          if [[ "$SAFE_TO_SYNC" == "true" ]]; then
            echo "" | tee -a "$LOG_FILE"
            echo "âœ… åˆ†æç»“æœ: å¯ä»¥å®‰å…¨åŒæ­¥" | tee -a "$LOG_FILE"
            echo "safe_to_sync=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œå°†æ‰§è¡ŒåŒæ­¥"
          else
            echo "" | tee -a "$LOG_FILE"
            echo "âŒ åˆ†æç»“æœ: ä¸å»ºè®®è‡ªåŠ¨åŒæ­¥" | tee -a "$LOG_FILE"
            echo "åŸå› :" | tee -a "$LOG_FILE"
            echo -e "$BLOCK_REASONS" | tee -a "$LOG_FILE"
            echo "" | tee -a "$LOG_FILE"
            echo "ğŸ’¡ å»ºè®®: è¯·æ‰‹åŠ¨æ£€æŸ¥ä¸Šæ¸¸å˜æ›´ï¼Œæˆ–ä½¿ç”¨ force_sync å‚æ•°å¼ºåˆ¶åŒæ­¥" | tee -a "$LOG_FILE"
            echo "safe_to_sync=false" >> $GITHUB_OUTPUT
            echo "block_reason=$BLOCK_REASONS" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ åŒæ­¥è¢«å®‰å…¨ä¿æŠ¤é˜»æ­¢ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—"
          fi

      - name: æ‰§è¡ŒåŒæ­¥æ“ä½œ
        if: steps.analyze_changes.outputs.safe_to_sync == 'true'
        run: |
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          
          echo "ğŸ”„ å¼€å§‹æ‰§è¡ŒåŒæ­¥..." | tee -a "$LOG_FILE"
          git checkout "${{ steps.detect_branches.outputs.local_branch }}"
          
          # å°è¯•åˆå¹¶
          if ! git merge --no-edit "upstream/${{ steps.detect_branches.outputs.upstream_branch }}"; then
            echo "âŒ åˆå¹¶å†²çªï¼Œè¯·æ‰‹åŠ¨å¤„ç†ä»¥ä¸‹æ–‡ä»¶ï¼š" | tee -a "$LOG_FILE"
            git diff --name-only --diff-filter=U | tee -a "$LOG_FILE"
            echo "" | tee -a "$LOG_FILE"
            echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š" | tee -a "$LOG_FILE"
            echo "  1. åœ¨ GitHub ç½‘é¡µç«¯ç‚¹å‡» 'Sync fork' æŒ‰é’®" | tee -a "$LOG_FILE"
            echo "  2. å¦‚æœ‰å†²çªï¼Œç‚¹å‡» 'Resolve conflicts' åœ¨çº¿è§£å†³" | tee -a "$LOG_FILE"
            exit 1
          fi
          
          echo "âœ… åˆå¹¶æˆåŠŸ" | tee -a "$LOG_FILE"

      - name: æ¢å¤ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ
        if: steps.analyze_changes.outputs.safe_to_sync == 'true' && steps.backup_workflows.outputs.backup_count != '0'
        run: |
          BACKUP_DIR="${{ steps.backup_workflows.outputs.backup_dir }}"
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          RESTORED_COUNT=0
          
          # æ¢å¤ my-*.yml å·¥ä½œæµæ–‡ä»¶
          if [[ -d "$BACKUP_DIR" ]]; then
            for FILE in "$BACKUP_DIR"/*.yml "$BACKUP_DIR"/*.yaml; do
              if [[ -f "$FILE" ]]; then
                FILENAME=$(basename "$FILE")
                # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
                mkdir -p ".github/workflows"
                cp -p "$FILE" ".github/workflows/$FILENAME"
                git add ".github/workflows/$FILENAME"
                RESTORED_COUNT=$((RESTORED_COUNT + 1))
                echo "  æ¢å¤: $FILENAME" | tee -a "$LOG_FILE"
              fi
            done
          fi
          
          # å¦‚æœæœ‰æ–‡ä»¶è¢«æ¢å¤ï¼Œåˆ›å»ºä¸€ä¸ªæäº¤
          if [[ $RESTORED_COUNT -gt 0 ]]; then
            if ! git diff --cached --quiet; then
              git commit -m "ğŸ›¡ï¸ ä¿æŠ¤ç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ (my-*.yml)"
              echo "ğŸ“¦ å·²æ¢å¤ $RESTORED_COUNT ä¸ªç”¨æˆ·è‡ªå®šä¹‰å·¥ä½œæµ" | tee -a "$LOG_FILE"
            fi
          fi

      - name: æ¨é€æ›´æ–°åˆ°Forkä»“åº“
        if: steps.analyze_changes.outputs.safe_to_sync == 'true'
        run: |
          LOG_FILE="${{ steps.init_protection_log.outputs.log_file }}"
          LOCAL_BRANCH="${{ steps.detect_branches.outputs.local_branch }}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…çš„æäº¤éœ€è¦æ¨é€
          if git log "origin/$LOCAL_BRANCH..HEAD" --oneline | grep -q .; then
            echo "ğŸ“¤ å‡†å¤‡æ¨é€æ›´æ–°..." | tee -a "$LOG_FILE"
            
            # æ˜¾ç¤ºå³å°†æ¨é€çš„æäº¤
            COMMIT_COUNT=$(git log "origin/$LOCAL_BRANCH..HEAD" --oneline | wc -l)
            echo "å³å°†æ¨é€ $COMMIT_COUNT ä¸ªæäº¤:" | tee -a "$LOG_FILE"
            git log "origin/$LOCAL_BRANCH..HEAD" --oneline | tee -a "$LOG_FILE"
            
            # æ‰§è¡Œæ¨é€
            if git push origin "$LOCAL_BRANCH"; then
              echo "âœ… åŒæ­¥æˆåŠŸå®Œæˆï¼" | tee -a "$LOG_FILE"
              echo "" | tee -a "$LOG_FILE"
              echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡:" | tee -a "$LOG_FILE"
              echo "  - åˆ é™¤æ–‡ä»¶: ${{ steps.analyze_changes.outputs.deleted_count }}" | tee -a "$LOG_FILE"
              echo "  - æ–°å¢æ–‡ä»¶: ${{ steps.analyze_changes.outputs.added_count }}" | tee -a "$LOG_FILE"
              echo "  - ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze_changes.outputs.modified_count }}" | tee -a "$LOG_FILE"
              echo "  - ä»£ç å˜åŒ–: ${{ steps.analyze_changes.outputs.lines_changed }}è¡Œ" | tee -a "$LOG_FILE"
              echo "  - å˜æ›´æ¨¡å¼: ${{ steps.analyze_changes.outputs.change_pattern }}" | tee -a "$LOG_FILE"
              echo "  - é£é™©ç­‰çº§: ${{ steps.analyze_changes.outputs.risk_level }}" | tee -a "$LOG_FILE"
              echo "  - æ¨é€æäº¤: $COMMIT_COUNT ä¸ª" | tee -a "$LOG_FILE"
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™å’Œç½‘ç»œè¿æ¥" | tee -a "$LOG_FILE"
              exit 1
            fi
          else
            echo "âš ï¸ æ²¡æœ‰éœ€è¦æ¨é€çš„æ–°æäº¤" | tee -a "$LOG_FILE"
          fi

      - name: åŒæ­¥è¢«é˜»æ­¢ï¼ˆå®‰å…¨ä¿æŠ¤è§¦å‘ï¼‰
        if: steps.analyze_changes.outputs.safe_to_sync == 'false'
        run: |
          echo "::error::ğŸš« åŒæ­¥è¢«æ™ºèƒ½ä¿æŠ¤é˜»æ­¢"
          echo ""
          echo "===== ğŸš« åŒæ­¥è¢«å®‰å…¨ä¿æŠ¤é˜»æ­¢ ====="
          echo ""
          echo "ğŸ“Š è¯¦ç»†ç»Ÿè®¡:"
          echo "  æ–‡ä»¶å˜åŒ–:"
          echo "    - åˆ é™¤æ–‡ä»¶: ${{ steps.analyze_changes.outputs.deleted_count }} (${{ steps.analyze_changes.outputs.delete_ratio }}%)"
          echo "    - æ–°å¢æ–‡ä»¶: ${{ steps.analyze_changes.outputs.added_count }}"
          echo "    - ä¿®æ”¹æ–‡ä»¶: ${{ steps.analyze_changes.outputs.modified_count }}"
          echo "    - å…³é”®æ–‡ä»¶åˆ é™¤: ${{ steps.analyze_changes.outputs.critical_deleted }}"
          echo ""
          echo "  ä»£ç å˜åŒ–:"
          echo "    - æ–°å¢è¡Œæ•°: +${{ steps.analyze_changes.outputs.lines_added }}"
          echo "    - åˆ é™¤è¡Œæ•°: -${{ steps.analyze_changes.outputs.lines_deleted }}"
          echo "    - æ™ºèƒ½é‡‡ç”¨å€¼: ${{ steps.analyze_changes.outputs.lines_changed }} è¡Œ"
          echo "    - å˜æ›´æ¨¡å¼: ${{ steps.analyze_changes.outputs.change_pattern }}"
          echo "    - é£é™©ç­‰çº§: ${{ steps.analyze_changes.outputs.risk_level }}"
          echo ""
          echo "ğŸ›¡ï¸ è§¦å‘çš„ä¿æŠ¤æœºåˆ¶:"
          echo -e "${{ steps.analyze_changes.outputs.block_reason }}"
          echo ""
          echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
          echo "  1. æŸ¥çœ‹ä¸Šæ¸¸ä»“åº“çš„å˜æ›´: https://github.com/${{ env.UPSTREAM_REPO }}/commits"
          echo "  2. å¦‚ç¡®è®¤å˜æ›´å®‰å…¨ï¼Œæ‰‹åŠ¨è¿è¡Œå·¥ä½œæµå¹¶å‹¾é€‰ 'force_sync' é€‰é¡¹"
          echo "  3. æˆ–åœ¨ GitHub ç½‘é¡µç«¯æ‰‹åŠ¨åŒæ­¥"
          echo ""
          echo "ğŸ“– è¯¦ç»†æ—¥å¿—å·²ä¿å­˜ï¼Œè¯·æŸ¥çœ‹ Artifacts ä¸­çš„ sync-protection-log"
          exit 1

      - name: ä¸Šä¼ åŒæ­¥æ—¥å¿—
        if: always() && steps.init_protection_log.outputs.log_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: sync-protection-log-${{ github.run_id }}
          path: ${{ steps.init_protection_log.outputs.log_file }}
          retention-days: 30
